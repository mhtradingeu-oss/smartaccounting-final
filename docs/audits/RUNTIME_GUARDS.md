# RUNTIME GUARDS: Optional Modules

## AI (ai_insights, aiEnabled)

- **Guard:** Before any DB read/write to `ai_insights` or related tables, `checkTableAndColumns` is called.
- **Behavior if missing schema:**
  - If required table/columns are missing, operation fails closed with HTTP 503 ("AI schema missing or incomplete").
  - If `aiEnabled` is false for company, operation fails closed with HTTP 501 ("AI disabled").
- **Error codes/messages:**
  - 503: AI schema missing or incomplete
  - 501: AI disabled

## OCR (FileAttachment optional fields)

- **Guard:** Before using OCR-related columns in `FileAttachment`, `checkTableAndColumns` is called.
- **Behavior if missing schema:**
  - If required columns are missing, OCR endpoints return `{ success: false, error: 'OCR schema missing or incomplete' }`.
  - No server crash; core flows continue.
- **Error codes/messages:**
  - 503: OCR schema missing or incomplete (if surfaced to API)

## Demo Mode

- **Guard:** Demo seeders and demo-only features require `DEMO_MODE` and `ALLOW_DEMO_SEED` flags.
- **Behavior if missing flags:**
  - Operation aborts with clear error, no data is seeded.
- **Error codes/messages:**
  - 400/401: Demo mode not enabled

## Audit Log

- **Guard:** If audit log write fails, parent operation is aborted (fail closed, not fallback).
- **Behavior if missing schema:**
  - Operation aborts with error; no partial writes.
- **Error codes/messages:**
  - 500: Audit log write failed: <reason>

## Implementation Notes

- All guards use a runtime schema check utility (`checkTableAndColumns`) with in-memory caching for performance.
- Guards are enforced at service entry points, not just at migration time.
- All error codes and messages are designed to be clear and actionable for both users and operators.

---

_Generated by runtime guard audit, 2025-12-29._
