  console.log
    [DB] test sqlite storage = :memory:

      at log (src/config/database.js:118:13)

  console.debug
    [authMiddleware][TEST] Authenticated user: userId: 2 companyId: 3

      at debug (src/middleware/authMiddleware.js:56:15)

  console.debug
    [authMiddleware][TEST] Authenticated user: userId: 2 companyId: 3

      at debug (src/middleware/authMiddleware.js:56:15)

FAIL tests/routes/aiSuggest.test.js
  AI Suggestions API
    ✕ returns 501 when AI suggestions are disabled (14 ms)

  ● AI Suggestions API › returns 501 when AI suggestions are disabled

    expect(received).toBe(expected) // Object.is equality

    Expected: 501
    Received: 404

      40 |       query: { prompt: 'Suggest actions' },
      41 |     });
    > 42 |     expect(res.res.statusCode).toBe(501);
         |                                ^
      43 |     expect(res.body).toMatchObject({
      44 |       errorCode: 'AI_SUGGEST_NOT_READY',
      45 |       message: 'AI suggestions are not production-ready',

      at Object.toBe (tests/routes/aiSuggest.test.js:42:32)

  console.log
    [DB] test sqlite storage = :memory:

      at log (src/config/database.js:118:13)

  console.debug
    [authMiddleware][TEST] Authenticated user: userId: 5 companyId: 3

      at debug (src/middleware/authMiddleware.js:56:15)

  console.debug
    [authMiddleware][TEST] Authenticated user: userId: 2 companyId: 3

      at debug (src/middleware/authMiddleware.js:56:15)

  console.debug
    [authMiddleware][TEST] Authenticated user: userId: 2 companyId: 3

      at debug (src/middleware/authMiddleware.js:56:15)

  console.debug
    [authMiddleware][TEST] Authenticated user: userId: 2 companyId: 3

      at debug (src/middleware/authMiddleware.js:56:15)

  console.debug
    [authMiddleware][TEST] Authenticated user: userId: 2 companyId: 3

      at debug (src/middleware/authMiddleware.js:56:15)

  console.debug
    [authMiddleware][TEST] Authenticated user: userId: 2 companyId: 3

      at debug (src/middleware/authMiddleware.js:56:15)

  console.debug
    [authMiddleware][TEST] Authenticated user: userId: 2 companyId: 3

      at debug (src/middleware/authMiddleware.js:56:15)

FAIL tests/routes/aiAssistantRead.test.js
  AI Text Assistant API
    ✕ should forbid viewer and auditor roles (6 ms)
    ✕ returns structured errors for wrong method (9 ms)
    ✕ should allow admin and accountant roles (7 ms)

  ● AI Text Assistant API › should forbid viewer and auditor roles

    expect(received).toMatchObject(expected)

    - Expected  - 2
    + Received  + 1

      Object {
    -   "errorCode": "AI_ASSISTANT_FORBIDDEN",
    -   "message": "Insufficient role for AI assistant",
    +   "message": "Access denied",
      }

      55 |     });
      56 |     expect(viewerRes.res.statusCode).toBe(403);
    > 57 |     expect(viewerRes.body).toMatchObject({
         |                            ^
      58 |       errorCode: 'AI_ASSISTANT_FORBIDDEN',
      59 |       message: 'Insufficient role for AI assistant',
      60 |     });

      at Object.toMatchObject (tests/routes/aiAssistantRead.test.js:57:28)

  ● AI Text Assistant API › returns structured errors for wrong method

    expect(received).toBe(expected) // Object.is equality

    Expected: 405
    Received: 403

      83 |       headers: { Authorization: `Bearer ${adminToken}`, ...AI_HEADERS, 'x-company-id': company.id },
      84 |     });
    > 85 |     expect(res.res.statusCode).toBe(405);
         |                                ^
      86 |     expect(res.body).toMatchObject({
      87 |       errorCode: 'METHOD_NOT_ALLOWED',
      88 |       message: 'POST is required for AI assistant requests',

      at Object.toBe (tests/routes/aiAssistantRead.test.js:85:32)

  ● AI Text Assistant API › should allow admin and accountant roles

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 405

      100 |       body: { intent: 'review', prompt: 'Summarize status', sessionId: 'session-test' },
      101 |     });
    > 102 |     expect(adminRes.res.statusCode).toBe(200);
          |                                     ^
      103 |     expect(adminRes.body.requestId).toBeTruthy();
      104 |
      105 |     const accountantRes = await global.requestApp({

      at Object.toBe (tests/routes/aiAssistantRead.test.js:102:37)

  console.log
    [DB] test sqlite storage = :memory:

      at log (src/config/database.js:118:13)

  console.debug
    [authMiddleware][TEST] Authenticated user: userId: 2 companyId: 3

      at debug (src/middleware/authMiddleware.js:56:15)

  console.debug
    [authMiddleware][TEST] Authenticated user: userId: 2 companyId: 3

      at debug (src/middleware/authMiddleware.js:56:15)

  console.debug
    [authMiddleware][TEST] Authenticated user: userId: 2 companyId: 3

      at debug (src/middleware/authMiddleware.js:56:15)

FAIL tests/routes/aiAssistantStream.test.js
  AI Assistant Stream API
    ✕ streams chunks with requestId and done event (7 ms)

  ● AI Assistant Stream API › streams chunks with requestId and done event

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 405

      40 |       body: { intent: 'review', prompt: 'Summarize status', sessionId: 'session-test' },
      41 |     });
    > 42 |     expect(res.res.statusCode).toBe(200);
         |                                ^
      43 |     expect(typeof res.body).toBe('string');
      44 |     expect(res.body).toContain('event: chunk');
      45 |     expect(res.body).toContain('event: done');

      at Object.toBe (tests/routes/aiAssistantStream.test.js:42:32)

Test Suites: 3 failed, 3 total
Tests:       5 failed, 5 total
Snapshots:   0 total
Time:        2.365 s, estimated 3 s
Ran all test suites matching /tests\/routes\/aiAssistantRead.test.js|tests\/routes\/aiAssistantStream.test.js|tests\/routes\/aiSuggest.test.js/i.
Force exiting Jest: Have you considered using `--detectOpenHandles` to detect async operations that kept running after all tests finished?
