  console.log
    [DB] test sqlite storage = :memory:

      at log (src/config/database.js:118:13)

  console.debug
    [authMiddleware][TEST] Authenticated user: userId: 2 companyId: 3

      at debug (src/middleware/authMiddleware.js:56:15)

  console.debug
    [authMiddleware][TEST] Authenticated user: userId: 2 companyId: 3

      at debug (src/middleware/authMiddleware.js:56:15)

  console.debug
    [authMiddleware][TEST] Authenticated user: userId: 2 companyId: 3

      at debug (src/middleware/authMiddleware.js:56:15)

STREAM_ERROR_STACK:TypeError: Cannot read properties of undefined (reading 'push')
    at ServerResponse._writeRaw (node:_http_outgoing:447:19)
    at ServerResponse._send (node:_http_outgoing:421:15)
    at ServerResponse.flushHeaders (node:_http_outgoing:1242:8)
    at flushHeaders (/Users/nadeemnour/smartaccounting-final/src/routes/aiReadOnly.js:363:13)
    at Layer.handle [as handle_request] (/Users/nadeemnour/smartaccounting-final/node_modules/express/lib/router/layer.js:95:5)
    at next (/Users/nadeemnour/smartaccounting-final/node_modules/express/lib/router/route.js:149:13)
    at next (/Users/nadeemnour/smartaccounting-final/src/middleware/aiRouteGuard.js:107:14)
    at Layer.handle [as handle_request] (/Users/nadeemnour/smartaccounting-final/node_modules/express/lib/router/layer.js:95:5)
    at next (/Users/nadeemnour/smartaccounting-final/node_modules/express/lib/router/route.js:149:13)
    at next (/Users/nadeemnour/smartaccounting-final/src/middleware/planGuard.js:37:14)
    at Layer.handle [as handle_request] (/Users/nadeemnour/smartaccounting-final/node_modules/express/lib/router/layer.js:95:5)
    at next (/Users/nadeemnour/smartaccounting-final/node_modules/express/lib/router/route.js:149:13)
    at Route.dispatch (/Users/nadeemnour/smartaccounting-final/node_modules/express/lib/router/route.js:119:3)
    at Layer.handle [as handle_request] (/Users/nadeemnour/smartaccounting-final/node_modules/express/lib/router/layer.js:95:5)
    at /Users/nadeemnour/smartaccounting-final/node_modules/express/lib/router/index.js:284:15
    at Function.process_params (/Users/nadeemnour/smartaccounting-final/node_modules/express/lib/router/index.js:346:12)
    at next (/Users/nadeemnour/smartaccounting-final/node_modules/express/lib/router/index.js:280:10)
    at next (/Users/nadeemnour/smartaccounting-final/src/middleware/aiRateLimit.js:37:3)
    at Layer.handle [as handle_request] (/Users/nadeemnour/smartaccounting-final/node_modules/express/lib/router/layer.js:95:5)
    at trim_prefix (/Users/nadeemnour/smartaccounting-final/node_modules/express/lib/router/index.js:328:13)
    at /Users/nadeemnour/smartaccounting-final/node_modules/express/lib/router/index.js:286:9
    at Function.process_params (/Users/nadeemnour/smartaccounting-final/node_modules/express/lib/router/index.js:346:12)
    at next (/Users/nadeemnour/smartaccounting-final/node_modules/express/lib/router/index.js:280:10)
    at next (/Users/nadeemnour/smartaccounting-final/src/middleware/planGuard.js:37:14)
    at Layer.handle [as handle_request] (/Users/nadeemnour/smartaccounting-final/node_modules/express/lib/router/layer.js:95:5)
    at trim_prefix (/Users/nadeemnour/smartaccounting-final/node_modules/express/lib/router/index.js:328:13)
    at /Users/nadeemnour/smartaccounting-final/node_modules/express/lib/router/index.js:286:9
    at Function.process_params (/Users/nadeemnour/smartaccounting-final/node_modules/express/lib/router/index.js:346:12)
    at next (/Users/nadeemnour/smartaccounting-final/node_modules/express/lib/router/index.js:280:10)
    at next (/Users/nadeemnour/smartaccounting-final/src/middleware/requireCompany.js:193:14)
  console.info
    [2026-01-11T16:06:34.555Z] [INFO] HTTP request {"meta":{"method":"post","path":"/api/ai/read/assistant/stream","ip":"127.0.0.1","userAgent":"","statusCode":200,"durationMs":16.17,"requestId":"02f38b13-28a6-4ba4-94bd-2cca2a98f145","userId":2,"companyId":3}}

      at method (src/lib/logger/index.js:217:3)

FAIL tests/routes/aiAssistantStream.test.js
  AI Assistant Stream API
    ✕ streams chunks with requestId and done event (23 ms)

  ● AI Assistant Stream API › streams chunks with requestId and done event

    expect(received).toContain(expected) // indexOf

    Expected substring: "event: chunk"
    Received string:    "event: error
    data: {\"errorCode\":\"AI_STREAM_ERROR\",\"message\":\"Cannot read properties of undefined (reading 'push')\",\"requestId\":\"02f38b13-28a6-4ba4-94bd-2cca2a98f145\"}·
    event: done
    data: {\"requestId\":\"02f38b13-28a6-4ba4-94bd-2cca2a98f145\"}·
    "

      42 |     expect(res.res.statusCode).toBe(200);
      43 |     expect(typeof res.body).toBe('string');
    > 44 |     expect(res.body).toContain('event: chunk');
         |                      ^
      45 |     expect(res.body).toContain('event: done');
      46 |     expect(res.body).toMatch(/requestId/);
      47 |   });

      at Object.toContain (tests/routes/aiAssistantStream.test.js:44:22)

Test Suites: 1 failed, 1 total
Tests:       1 failed, 1 total
Snapshots:   0 total
Time:        1.266 s, estimated 2 s
Ran all test suites matching /tests\/routes\/aiAssistantStream.test.js/i.
Force exiting Jest: Have you considered using `--detectOpenHandles` to detect async operations that kept running after all tests finished?
