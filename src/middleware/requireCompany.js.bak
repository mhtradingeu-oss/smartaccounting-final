const { updateRequestContext } = require("../lib/logger/context");
const logger = require("../lib/logger");
const { User, Company } = require("../models");
const ApiError = require("../lib/errors/apiError");

const parseCompanyId = (value) => {
  if (value === undefined || value === null || value === "") {
    return null;
  }
  const parsed = Number(value);
  return Number.isInteger(parsed) ? parsed : null;
};

const UUID_REGEX = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
const UUID_COMPANY_COLUMNS = [
  "uuid",
  "companyUuid",
  "company_uuid",
  "publicId",
  "public_id",
  "externalId",
  "external_id",
];

const isUuid = (value) => UUID_REGEX.test(String(value || "").trim());

let cachedCompanyUuidColumn = null;
let cachedCompanyUuidColumnChecked = false;
let cachedCompanyUuidColumnPromise = null;

const resolveCompanyUuidColumn = async () => {
  if (cachedCompanyUuidColumnChecked) {
    return cachedCompanyUuidColumn;
  }
  if (cachedCompanyUuidColumnPromise) {
    return cachedCompanyUuidColumnPromise;
  }
  cachedCompanyUuidColumnPromise = (async () => {
    try {
      const queryInterface = Company.sequelize.getQueryInterface();
      const table = await queryInterface.describeTable("companies");
      const columns = Object.keys(table || {});
      for (const candidate of UUID_COMPANY_COLUMNS) {
        if (columns.includes(candidate)) {
          cachedCompanyUuidColumn = candidate;
          break;
        }
      }
      cachedCompanyUuidColumnChecked = true;
      return cachedCompanyUuidColumn;
    } catch (error) {
      cachedCompanyUuidColumnChecked = true;
      return cachedCompanyUuidColumn;
    } finally {
      cachedCompanyUuidColumnPromise = null;
    }
  })();
  return cachedCompanyUuidColumnPromise;
};

const logCompanyContextFailure = ({ req, attemptedCompanyId, attemptedCompanyUuid, reason }) => {
  // ...existing code...

  function requireCompanyContext(req, res, next) {
    // Check for company context in token or user
    const companyId = req.tokenCompanyId || req.user?.companyId;
    if (!companyId) {
      return next(
        new ApiError(403, "COMPANY_CONTEXT_INVALID", "Token does not include company context"),
      );
    }
    next();
  }

  module.exports = requireCompanyContext;
  logger.warn("Company context rejected", {
    requestId: req.requestId,
    userId: req.userId || req.user?.id || null,
    attemptedCompanyId,
    attemptedCompanyUuid,
    route: req.originalUrl,
    reason,
  });
};

const createRequireCompanyMiddleware =
  (options = {}) =>
  async (req, res, next) => {
    const { allowSystemAdmin = false } = options;
    try {
      const rawHeaderValue = req.headers?.["x-company-id"];
      const headerValue = Array.isArray(rawHeaderValue) ? rawHeaderValue[0] : rawHeaderValue;
      const normalizedHeaderValue =
        typeof headerValue === "string" ? headerValue.trim() : headerValue;

      if (
        normalizedHeaderValue === undefined ||
        normalizedHeaderValue === null ||
        normalizedHeaderValue === ""
      ) {
        logCompanyContextFailure({ req, attemptedCompanyId: null, reason: "missing_header" });
        return next(
          new ApiError(400, "COMPANY_CONTEXT_REQUIRED", "x-company-id header is required"),
        );
      }

      let requestedCompanyId = parseCompanyId(normalizedHeaderValue);
      let requestedCompanyUuid = null;

      if (requestedCompanyId === null) {
        if (!isUuid(normalizedHeaderValue)) {
          logCompanyContextFailure({
            req,
            attemptedCompanyId: normalizedHeaderValue,
            reason: "invalid_header",
          });
          return next(new ApiError(403, "Company context is invalid", "COMPANY_CONTEXT_INVALID"));
        }

        requestedCompanyUuid = String(normalizedHeaderValue).trim();
        const uuidColumn = await resolveCompanyUuidColumn();
        if (!uuidColumn) {
          logCompanyContextFailure({
            req,
            attemptedCompanyUuid: requestedCompanyUuid,
            reason: "uuid_column_missing",
          });
          return next(new ApiError(403, "Company context is invalid", "COMPANY_CONTEXT_INVALID"));
        }

        const company = await Company.findOne({
          where: { [uuidColumn]: requestedCompanyUuid },
          attributes: ["id"],
          raw: true,
        });
        if (!company || !company.id) {
          logCompanyContextFailure({
            req,
            attemptedCompanyUuid: requestedCompanyUuid,
            reason: "company_not_found",
          });
          return next(new ApiError(403, "Company context is invalid", "COMPANY_CONTEXT_INVALID"));
        }

        requestedCompanyId = company.id;
      }

      if (requestedCompanyId === null) {
        logCompanyContextFailure({
          req,
          attemptedCompanyId: normalizedHeaderValue,
          reason: "invalid_header",
        });
        return next(new ApiError(403, "Company context is invalid", "COMPANY_CONTEXT_INVALID"));
      }

      if (req.isSystemAdmin && !allowSystemAdmin) {
        logCompanyContextFailure({
          req,
          attemptedCompanyId: requestedCompanyId,
          reason: "system_admin_blocked",
        });
        return next(new ApiError(403, "Company context is invalid", "COMPANY_CONTEXT_INVALID"));
      }

      const userId = req.userId || req.user?.id;
      if (!userId) {
        logCompanyContextFailure({
          req,
          attemptedCompanyId: requestedCompanyId,
          reason: "missing_user",
        });
        return next(new ApiError(403, "Company context is invalid", "COMPANY_CONTEXT_INVALID"));
      }

      if (!req.isSystemAdmin) {
        const user = await User.findByPk(userId, { attributes: ["id", "companyId"] });
        if (!user || !user.companyId || String(user.companyId) !== String(requestedCompanyId)) {
          logCompanyContextFailure({
            req,
            attemptedCompanyId: requestedCompanyId,
            reason: "company_mismatch",
          });
          return next(new ApiError(403, "Company context is invalid", "COMPANY_CONTEXT_INVALID"));
        }
      }

      req.companyId = requestedCompanyId;
      if (requestedCompanyUuid) {
        req.companyUuid = requestedCompanyUuid;
      }
      updateRequestContext({ companyId: requestedCompanyId });
      return next();
    } catch (error) {
      return next(error);
    }
  };

const requireCompany = (reqOrOptions, res, next) => {
  if (
    reqOrOptions &&
    typeof reqOrOptions === "object" &&
    typeof res === "object" &&
    typeof next === "function"
  ) {
    return createRequireCompanyMiddleware({})(reqOrOptions, res, next);
  }
  return createRequireCompanyMiddleware(reqOrOptions);
};

module.exports = requireCompany;
